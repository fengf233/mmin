<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <title>性能测试工具</title>
    <link rel="icon" href="/static/logo.png" type="image/png">
    <link rel="stylesheet" href="/static/layui/css/layui.css">
    <script src="/static/layui/layui.js"></script>
    <script src="/static/echarts.min.js"></script>
    <style>
        .layui-layout-admin .layui-body {
            padding: 15px;
        }
        .chart-container {
            height: 300px;
            margin-bottom: 20px;
        }
        .data-overview {
            padding: 10px;
        }
        .data-card {
            text-align: center;
            padding: 20px;
            background-color: #fff;
            border-radius: 2px;
            box-shadow: 0 1px 2px 0 rgba(0,0,0,.05);
        }
        .data-card h2 {
            font-size: 24px;
            color: #009688;
        }
        .data-card p {
            margin-top: 10px;
            color: #666;
        }
        .layui-card {
            margin-bottom: 15px;
        }
    </style>
</head>
<body class="layui-layout-body">
    <div class="layui-layout layui-layout-admin">
        <!-- 头部 -->
        <div class="layui-header">
            <div class="layui-logo">
                <img src="/static/logo.png" alt="Logo" style="height: 45px; margin-right: 10px; vertical-align: middle;">
                性能测试工具
            </div>
        </div>

        <!-- 左侧导航栏 -->
        <div class="layui-side layui-bg-black">
            <div class="layui-side-scroll">
                <ul class="layui-nav layui-nav-tree">
                    <li class="layui-nav-item">
                        <a href="javascript:;" onclick="showTab('config')">配置</a>
                    </li>
                    <li class="layui-nav-item">
                        <a href="javascript:;" onclick="showTab('report')">报告</a>
                    </li>
                    <li class="layui-nav-item">
                        <a href="javascript:;" onclick="showTestHistory()">历史记录</a>
                    </li>
                </ul>
            </div>
        </div>

        <!-- 主体内容 -->
        <div class="layui-body">
            <!-- 配置部分 -->
            <div id="configTab">
                <div class="layui-tab layui-tab-brief">
                    <ul class="layui-tab-title">
                        <li class="layui-this">基础配置</li>
                        <li>TCP组配置</li>
                        <li>HTTP配置</li>
                        <li>参数替换</li>
                    </ul>
                    <div class="layui-tab-content">
                        <!-- 基础配置 -->
                        <div class="layui-tab-item layui-show">
                            <form class="layui-form">
                                <div class="layui-form-item">
                                    <label class="layui-form-label">运行时间(秒)</label>
                                    <div class="layui-input-inline">
                                        <input type="number" name="runtime" class="layui-input" value="30">
                                    </div>
                                </div>
                                <div class="layui-form-item" style="display: none;">
                                    <label class="layui-form-label">调试模式</label>
                                    <div class="layui-input-block">
                                        <input type="checkbox" name="debug" lay-skin="switch" lay-text="开启|关闭">
                                    </div>
                                </div>
                                <div class="layui-form-item" style="display: none;">
                                    <label class="layui-form-label">远程服务器</label>
                                    <div class="layui-input-block">
                                        <div id="remoteServerContainer">
                                            <!-- 远程服务器配置 -->
                                        </div>
                                        <div style="margin-top: 10px;">
                                            <button type="button" class="layui-btn layui-btn-sm" onclick="addRemoteServer()">
                                                <i class="layui-icon">&#xe654;</i> 添加
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </form>
                        </div>

                        <!-- TCP组配置 -->
                        <div class="layui-tab-item">
                            <div class="layui-btn-container">
                                <button class="layui-btn layui-btn-sm" onclick="addTcpGroup()">
                                    <i class="layui-icon">&#xe654;</i> 添加
                                </button>
                            </div>
                            <div id="tcpGroupsContainer"></div>
                        </div>

                        <!-- HTTP配置 -->
                        <div class="layui-tab-item">
                            <div class="layui-btn-container">
                                <button class="layui-btn layui-btn-sm" onclick="addHttpConf()">
                                    <i class="layui-icon">&#xe654;</i> 添加
                                </button>
                            </div>
                            <div id="httpConfContainer"></div>
                        </div>

                        <!-- 参数配置 -->
                        <div class="layui-tab-item">
                            <div class="layui-btn-container">
                                <button class="layui-btn layui-btn-sm" onclick="addParam()">
                                    <i class="layui-icon">&#xe654;</i> 添加
                                </button>
                            </div>
                            <div id="paramsContainer"></div>
                        </div>

                    </div>
                </div>
            </div>

            <!-- 报告部分 -->
            <div id="reportTab" style="display: none;">
                <!-- 数据概览 -->
                <div class="layui-row layui-col-space15 data-overview">
                    <div class="layui-col-md3">
                        <div class="data-card">
                            <h2 id="runtime">0</h2>
                            <p>运行时间</p>
                        </div>
                    </div>
                    <div class="layui-col-md3">
                        <div class="data-card">
                            <h2 id="currentQps">0</h2>
                            <p>当前QPS</p>
                        </div>
                    </div>
                    <div class="layui-col-md3">
                        <div class="data-card">
                            <h2 id="avgResponseTime">0ms</h2>
                            <p>响应时间</p>
                        </div>
                    </div>
                    <div class="layui-col-md3">
                        <div class="data-card">
                            <h2 id="successRate">100%</h2>
                            <p>成功率 </p>
                        </div>
                    </div>
                </div>
                <div class="layui-row layui-col-space15 data-overview">
                    <div class="layui-col-md3">
                        <div class="data-card">
                            <h2 id="send">0</h2>
                            <p>发送流量</p>
                        </div>
                    </div>
                    <div class="layui-col-md3">
                        <div class="data-card">
                            <h2 id="receive">0</h2>
                            <p>接收流量</p>
                        </div>
                    </div>
                    <div class="layui-col-md3">
                        <div class="data-card">
                            <h2 id="activeConnCount">0</h2>
                            <p>连接数 </p>
                        </div>
                    </div>
                    <div class="layui-col-md3">
                        <div class="data-card">
                            <h2 id="successCount">0</h2>
                            <p>成功数 </p>
                        </div>
                    </div>
                </div>

                <!-- 图表区域 -->
                <div class="layui-row layui-col-space15">
                    <div class="layui-col-md6">
                        <div class="layui-card">
                            <div class="layui-card-body">
                                <div id="qpsChart" class="chart-container"></div>
                            </div>
                        </div>
                    </div>
                    <div class="layui-col-md6">
                        <div class="layui-card">
                            <div class="layui-card-body">
                                <div id="trafficChart" class="chart-container"></div>
                            </div>
                        </div>
                    </div>
                    <div class="layui-col-md6">
                        <div class="layui-card">
                            <div class="layui-card-body">
                                <div id="responseTimeChart" class="chart-container"></div>
                            </div>
                        </div>
                    </div>
                    <div class="layui-col-md6">
                        <div class="layui-card">
                            <div class="layui-card-body">
                                <div id="statusCodeChart" class="chart-container"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 底部固定区域 -->
        <div class="layui-footer">
            <div class="layui-btn-container">
                <button class="layui-btn" onclick="saveConfig()">保存配置</button>
                <button class="layui-btn layui-btn-warning layui-bg-orange" onclick="importConfig()">导入配置</button>
                <button class="layui-btn layui-btn-normal" onclick="startTest()">开始测试</button>
                <button class="layui-btn layui-btn-danger layui-btn-disabled" onclick="stopTest()" disabled>停止测试</button>
            </div>
        </div>
    </div>

    <!-- 添加隐藏的文件输入 -->
    <input type="file" id="configFileInput" style="display: none" accept=".json,.yaml" onchange="handleConfigFile(this)">

    <script>
        // 添加测试状态变量
        let isTestRunning = false;

        // 添加轮询相关变量和函数
        let pollInterval;

        layui.use(['element', 'form', 'layer'], function(){
            var element = layui.element;
            var form = layui.form;
            var layer = layui.layer;
            
            // 初始化表单和按钮状态
            form.render();
            updateButtonStates();
        });

        // 添加按钮状态更新函数
        function updateButtonStates() {
            const startBtn = document.querySelector('button[onclick="startTest()"]');
            const stopBtn = document.querySelector('button[onclick="stopTest()"]');
            
            if (isTestRunning) {
                startBtn.classList.add('layui-btn-disabled');
                startBtn.disabled = true;
                stopBtn.classList.remove('layui-btn-disabled');
                stopBtn.disabled = false;
            } else {
                startBtn.classList.remove('layui-btn-disabled');
                startBtn.disabled = false;
                stopBtn.classList.add('layui-btn-disabled');
                stopBtn.disabled = true;
            }
        }

        // 切换标签页
        function showTab(tab) {
            if (tab === 'config') {
                document.getElementById('configTab').style.display = 'block';
                document.getElementById('reportTab').style.display = 'none';
            } else {
                document.getElementById('configTab').style.display = 'none';
                document.getElementById('reportTab').style.display = 'block';
                initCharts();
            }
        }

        // 添加TCP组
        function addTcpGroup() {
            const template = `
                <div class="layui-card">
                    <div class="layui-card-header">
                        TCP组配置
                        <button class="layui-btn layui-btn-danger layui-btn-xs" style="float:right" onclick="layui.$(this).parents('.layui-card').remove()">
                            <i class="layui-icon">&#xe640;</i>
                        </button>
                    </div>
                    <div class="layui-card-body">
                        <form class="layui-form">
                            <div class="layui-row layui-col-space10">
                                <div class="layui-col-md6">
                                    <div class="layui-form-item">
                                        <label class="layui-form-label">组名</label>
                                        <div class="layui-input-block">
                                            <input type="text" class="layui-input" id="Name" placeholder="group1">
                                        </div>
                                    </div>
                                </div>
                                <div class="layui-col-md6">
                                    <div class="layui-form-item">
                                        <label class="layui-form-label">目标地址</label>
                                        <div class="layui-input-block">
                                            <input type="text" class="layui-input" id="Dst" placeholder="2.0.0.67:80">
                                        </div>
                                    </div>
                                </div>
                                <div class="layui-col-md6">
                                    <div class="layui-form-item">
                                        <label class="layui-form-label">源IP列表</label>
                                        <div class="layui-input-block">
                                            <textarea class="layui-textarea" id="SrcIP" placeholder="2.0.0.19,2.0.0.100"></textarea>
                                        </div>
                                    </div>
                                </div>
                                <div class="layui-col-md6">
                                    <div class="layui-form-item">
                                        <label class="layui-form-label">HTTPS</label>
                                        <div class="layui-input-block">
                                            <input type="checkbox" lay-skin="switch" id="IsHttps" lay-text="是|否">
                                        </div>
                                    </div>
                                </div>
                                <div class="layui-col-md6">
                                    <div class="layui-form-item">
                                        <label class="layui-form-label">连接数/IP</label>
                                        <div class="layui-input-block">
                                            <input type="number" class="layui-input" id="MaxTcpConnPerIP" value="1000">
                                        </div>
                                    </div>
                                </div>
                                <div class="layui-col-md6">
                                    <div class="layui-form-item">
                                        <label class="layui-form-label">最大QPS</label>
                                        <div class="layui-input-block">
                                            <input type="number" class="layui-input" id="MaxQps" value="500">
                                        </div>
                                    </div>
                                </div>
                                <div class="layui-col-md6">
                                    <div class="layui-form-item">
                                        <label class="layui-form-label">请求线程</label>
                                        <div class="layui-input-block">
                                            <input type="number" class="layui-input" id="ReqThread" value="500">
                                        </div>
                                    </div>
                                </div>
                                <div class="layui-col-md6">
                                    <div class="layui-form-item">
                                        <label class="layui-form-label">请求数/TCP</label>
                                        <div class="layui-input-block">
                                            <input type="number" class="layui-input" id="MaxReqest" value="100">
                                        </div>
                                    </div>
                                </div>
                                <div class="layui-col-md12">
                                    <div class="layui-form-item">
                                        <label class="layui-form-label">HTTP请求</label>
                                        <div class="layui-input-block">
                                            <input type="text" class="layui-input" id="SendHttp" placeholder="http1,http2">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            `;
            document.getElementById('tcpGroupsContainer').insertAdjacentHTML('beforeend', template);
            layui.form.render();
        }

        // 添加参数
        function addParam() {
            const template = `
                <div class="layui-card">
                    <div class="layui-card-header">
                        参数配置
                        <button class="layui-btn layui-btn-danger layui-btn-xs" style="float:right" onclick="layui.$(this).parents('.layui-card').remove()">
                            <i class="layui-icon">&#xe640;</i>
                        </button>
                    </div>
                    <div class="layui-card-body">
                        <form class="layui-form">
                            <div class="layui-row layui-col-space10">
                                <div class="layui-col-md4">
                                    <div class="layui-form-item">
                                        <label class="layui-form-label">参数名</label>
                                        <div class="layui-input-block">
                                            <input type="text" class="layui-input" id="Name" placeholder="参数名">
                                        </div>
                                    </div>
                                </div>
                                <div class="layui-col-md4">
                                    <div class="layui-form-item">
                                        <label class="layui-form-label">类型</label>
                                        <div class="layui-input-block">
                                            <select id="Type">
                                                <option value="RandomInt">随机整数</option>
                                                <option value="RandomStr">随机字符串</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                                <div class="layui-col-md4">
                                    <div class="layui-form-item">
                                        <label class="layui-form-label">规格</label>
                                        <div class="layui-input-block">
                                            <input type="text" class="layui-input" id="Spec" placeholder="随机整数:1,10表示1~10中间随机">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            `;
            document.getElementById('paramsContainer').insertAdjacentHTML('beforeend', template);
            layui.form.render();
        }

        // 添加HTTP配置
        function addHttpConf() {
            const template = `
                <div class="layui-card">
                    <div class="layui-card-header">
                        HTTP配置
                        <button class="layui-btn layui-btn-danger layui-btn-xs" style="float:right" onclick="layui.$(this).parents('.layui-card').remove()">
                            <i class="layui-icon">&#xe640;</i>
                        </button>
                    </div>
                    <div class="layui-card-body">
                        <form class="layui-form">
                            <div class="layui-row layui-col-space10">
                                <div class="layui-col-md4">
                                    <div class="layui-form-item">
                                        <label class="layui-form-label">名称</label>
                                        <div class="layui-input-block">
                                            <input type="text" class="layui-input" id="Name" placeholder="test1">
                                        </div>
                                    </div>
                                </div>
                                <div class="layui-col-md4">
                                    <div class="layui-form-item">
                                        <label class="layui-form-label">协议</label>
                                        <div class="layui-input-block">
                                            <select id="Proto">
                                                <option value="HTTP/1.1" selected>HTTP/1.1</option>
                                                <option value="HTTP/1.0">HTTP/1.0</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                                <div class="layui-col-md4">
                                    <div class="layui-form-item">
                                        <label class="layui-form-label">方法</label>
                                        <div class="layui-input-block">
                                            <select id="Method">
                                                <option value="GET" selected>GET</option>
                                                <option value="POST">POST</option>
                                                <option value="PUT">PUT</option>
                                                <option value="DELETE">DELETE</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                                <div class="layui-col-md12">
                                    <div class="layui-form-item">
                                        <label class="layui-form-label">URI</label>
                                        <div class="layui-input-block">
                                            <input type="text" class="layui-input" id="URI" placeholder="/path?a=a">
                                        </div>
                                    </div>
                                </div>
                                <div class="layui-col-md12">
                                    <div class="layui-form-item">
                                        <label class="layui-form-label">Headers</label>
                                        <div class="layui-input-block">
                                            <div class="headers-container">
                                                <!-- Header 字段将被添加到这里 -->
                                            </div>
                                            <div style="margin-top: 10px;">
                                                <button type="button" class="layui-btn layui-btn-sm" onclick="addHeaderField(this)">
                                                    <i class="layui-icon">&#xe654;</i> 添加
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="layui-col-md12">
                                    <div class="layui-form-item">
                                        <label class="layui-form-label">Body</label>
                                        <div class="layui-input-block">
                                            <textarea class="layui-textarea" id="Body"></textarea>
                                        </div>
                                    </div>
                                </div>
                                <div class="layui-col-md12">
                                    <div class="layui-form-item">
                                        <label class="layui-form-label">参数替换</label>
                                        <div class="layui-input-block">
                                            <input type="text" class="layui-input" id="UseParams" placeholder="aaa,bbb">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            `;
            document.getElementById('httpConfContainer').insertAdjacentHTML('beforeend', template);
            layui.form.render();
        }

        // 添加 Header 字段
        function addHeaderField(button) {
            const template = `
                <div class="layui-form-item header-item">
                    <div class="layui-inline" style="width: 40%;">
                        <input type="text" class="layui-input" placeholder="Key">
                    </div>
                    <div class="layui-inline" style="width: 40%;">
                        <input type="text" class="layui-input" placeholder="Value">
                    </div>
                    <div class="layui-inline" style="width: 10%;">
                        <button type="button" class="layui-btn layui-btn-danger layui-btn-sm" onclick="this.parentElement.parentElement.remove()">
                            <i class="layui-icon">&#xe640;</i>
                        </button>
                    </div>
                </div>
            `;
            
            // 找到最近的 headers-container 并添加新的 header 字段
            const headersContainer = button.closest('.layui-form-item').querySelector('.headers-container');
            headersContainer.insertAdjacentHTML('beforeend', template);
            
            // 重新渲染表单
            layui.form.render();
        }

        // 初始化图表
        function initCharts() {
            document.getElementById('currentQps').innerText = 0;
            document.getElementById('avgResponseTime').innerText = 0 + 'ms';
            document.getElementById('successRate').innerText = 0 + '%';
            document.getElementById('send').innerText = 0 + 'MB/s';
            document.getElementById('receive').innerText = 0 + 'MB/s';
            document.getElementById('runtime').innerText = 0 + 's';
            document.getElementById('activeConnCount').innerText = 0;
            document.getElementById('successCount').innerText = 0;
            // QPS趋势图
            const qpsChart = echarts.init(document.getElementById('qpsChart'));
            const qpsOption = {
                title: { text: 'QPS趋势' },
                tooltip: { trigger: 'axis' },
                legend: {
                    data: ['QPS']
                },
                xAxis: { type: 'category', data: [] },
                yAxis: { 
                    type: 'value',
                    name: 'qps'
                },
                series: [
                    {
                        name: 'QPS',
                        type: 'line',
                        data: []
                    }
                ]
            };
            qpsChart.setOption(qpsOption);

            // 响应时间分布图
            const responseTimeChart = echarts.init(document.getElementById('responseTimeChart'));
            const responseTimeOption = {
                title: { text: '响应时间' },
                tooltip: { trigger: 'axis' },
                legend: {
                    data: ['响应时间']
                },
                xAxis: { type: 'category', data: [] },
                yAxis: { 
                    type: 'value',
                    name: 'ms'
                },
                series: [
                    {
                        name: '响应时间',
                        type: 'line',
                        data: []
                    }
                ]
            };
            responseTimeChart.setOption(responseTimeOption);

            // 状态码分布图
            const statusCodeChart = echarts.init(document.getElementById('statusCodeChart'));
            const statusCodeOption = {
                title: {
                    text: '状态码分布'
                },
                tooltip: {
                    trigger: 'item'
                },
                series: [{
                    name: '状态码',
                    type: 'pie',
                    radius: '50%',
                    data: [
                        {value: 0, name: '200'},
                        {value: 0, name: '4xx'},
                        {value: 0, name: '5xx'}
                    ]
                }]
            };
            statusCodeChart.setOption(statusCodeOption);

            // 流量统计图
            const trafficChart = echarts.init(document.getElementById('trafficChart'));
            trafficChart.setOption({
                title: { text: '流量统计' },
                tooltip: { trigger: 'axis' },
                legend: {
                    data: ['发送流量', '接收流量']
                },
                xAxis: { type: 'category', data: [] },
                yAxis: { 
                    type: 'value',
                    name: 'MB/s'
                },
                series: [
                    {
                        name: '发送流量',
                        type: 'line',
                        data: []
                    },
                    {
                        name: '接收流量',
                        type: 'line',
                        data: []
                    }
                ]
            });

            // 自动调整图表大小
            window.addEventListener('resize', function() {
                qpsChart.resize();
                responseTimeChart.resize();
                statusCodeChart.resize();
                trafficChart.resize();
            });

        }

        // 获取所有配置
        function getAllConfig() {
            const config = {
                RunTime: parseInt(document.querySelector('input[name="runtime"]').value),
                Debug: document.querySelector('input[name="debug"]').checked,
                RemoteServer: getRemoteServerConfig(),
                TcpGroups: getTcpGroups(),
                Params: getParams(),
                HTTPconfs: getHttpConfs()
            };
            return config;
        }

        // 获取远程服务器配置
        function getRemoteServerConfig() {
            const remoteServer = {};
            document.querySelectorAll('#remoteServerContainer .remote-server-item').forEach(item => {
                const address = item.querySelector('input[placeholder="服务器地址:端口"]').value;
                const groups = item.querySelector('input[placeholder="组名列表"]').value.split(',').map(g => g.trim());
                if (address && groups.length > 0) {
                    remoteServer[address] = groups;
                }
            });
            return remoteServer;
        }

        // 获取TCP组配置
        function getTcpGroups() {
            const groups = [];
            document.querySelectorAll('#tcpGroupsContainer .layui-card').forEach(card => {
                const group = {
                    Name: card.querySelector('input[id="Name"]').value,
                    MaxTcpConnPerIP: parseInt(card.querySelector('input[id="MaxTcpConnPerIP"]').value),
                    SrcIP: card.querySelector('textarea[id="SrcIP"]').value.split(','),
                    MaxQps: parseInt(card.querySelector('input[id="MaxQps"]').value),
                    Dst: card.querySelector('input[id="Dst"]').value,
                    IsHttps: card.querySelector('input[id="IsHttps"]').checked,
                    SendHttp: card.querySelector('input[id="SendHttp"]').value.split(','),
                    ReqThread: parseInt(card.querySelector('input[id="ReqThread"]').value),
                    MaxReqest: parseInt(card.querySelector('input[id="MaxReqest"]').value)
                };
                groups.push(group);
            });
            return groups;
        }

        // 获取参数配置
        function getParams() {
            const params = [];
            document.querySelectorAll('#paramsContainer .layui-card').forEach(card => {
                const param = {
                    Name: card.querySelector('input[id="Name"]').value,
                    Type: card.querySelector('select[id="Type"]').value,
                    Spec: card.querySelector('input[id="Spec"]').value.split(',')
                };
                params.push(param);
            });
            return params;
        }

        // 获取HTTP配置
        function getHttpConfs() {
            const confs = [];
            document.querySelectorAll('#httpConfContainer .layui-card').forEach(card => {
                const conf = {
                    Name: card.querySelector('input[id="Name"]').value,
                    Proto: card.querySelector('select[id="Proto"]').value,
                    Method: card.querySelector('select[id="Method"]').value,
                    URI: card.querySelector('input[id="URI"]').value,
                    Header: (() => {
                        const headers = {};
                        card.querySelectorAll('.header-item').forEach(item => {
                            const key = item.querySelector('input[placeholder="Key"]').value;
                            const value = item.querySelector('input[placeholder="Value"]').value;
                            if (key) headers[key] = value;
                        });
                        return headers;
                    })(),
                    Body: card.querySelector('textarea[id="Body"]').value,
                    UseParams:  card.querySelector('input[id="UseParams"]').value.split(',')
                };
                confs.push(conf);
            });
            return confs;
        }

        // 修改保存配置函数
        function saveConfig() {
            const config = getAllConfig();
            const jsonStr = JSON.stringify(config, null, 2);
            const blob = new Blob([jsonStr], { type: 'application/json' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'config.json';
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);
            layui.layer.msg('配置已下载');
        }

        // 修改开始测试函数
        function startTest() {
            if (isTestRunning) return;
            
            const config = getAllConfig();
            fetch('/api/test/start', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(config)
            })
            .then(response => {
                if (!response.ok) {
                    // 读取错误信息
                    return response.text().then(text => {
                        throw new Error(text);
                    });
                }
                return response.json();
            })
            .then(data => {
                showTab('report');
                layui.layer.msg('测试已开始');
                isTestRunning = true;
                updateButtonStates();
                startPolling();
            })
            .catch(error => {
                // 使用 layer 弹窗显示详细错误信息
                layui.layer.open({
                    type: 1,
                    title: '配置错误',
                    area: ['500px', 'auto'],
                    content: `<div style="padding: 20px;">
                        <div class="layui-bg-red" style="padding: 10px; border-radius: 4px;">
                            ${error.message}
                        </div>
                    </div>`,
                    btn: ['确定']
                });
            });
        }

        // 添加历史记录相关函数
        function saveTestResult(result) {
            // 从localStorage获取历史记录
            let history = JSON.parse(localStorage.getItem('testHistory') || '[]');
            
            // 添加新的测试结果，包含时间戳
            const testResult = {
                timestamp: new Date().toISOString(),
                result: result
            };
            
            // 将新结果添加到开头
            history.unshift(testResult);
            
            // 最多保存最近10条记录
            if (history.length > 10) {
                history = history.slice(0, 10);
            }
            
            // 保存回localStorage
            localStorage.setItem('testHistory', JSON.stringify(history));
        }

        // 显示历史记录
        function showTestHistory() {
            const history = JSON.parse(localStorage.getItem('testHistory') || '[]');
            if (history.length === 0) {
                layui.layer.msg('暂无历史记录');
                return;
            }

            let content = `
                <div style="padding: 20px;">
                    <table class="layui-table">
                        <thead>
                            <tr>
                                <th>测试时间</th>
                                <th>持续时间</th>
                                <th>总请求数</th>
                                <th>平均QPS</th>
                                <th>成功率</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${history.map((item, index) => `
                                <tr>
                                    <td>${new Date(item.timestamp).toLocaleString()}</td>
                                    <td>${item.result.duration.toFixed(2)}秒</td>
                                    <td>${item.result.totalRequests.toLocaleString()}</td>
                                    <td>${item.result.avgQps.toFixed(2)}</td>
                                    <td>${item.result.successRate.toFixed(2)}%</td>
                                    <td>
                                        <button class="layui-btn layui-btn-xs" onclick="showHistoryDetail(${index})">
                                            详情
                                        </button>
                                        <button class="layui-btn layui-btn-xs layui-btn-danger" onclick="deleteHistoryItem(${index})">
                                            删除
                                        </button>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;

            layui.layer.open({
                type: 1,
                title: '测试历史记录',
                area: ['900px', '600px'],
                content: content,
                btn: ['关闭'],
                yes: function(index) {
                    layui.layer.close(index);
                }
            });
        }

        // 显示历史记录详情
        function showHistoryDetail(index) {
            const history = JSON.parse(localStorage.getItem('testHistory') || '[]');
            if (index >= 0 && index < history.length) {
                showTestResult(history[index].result);
            }
        }

        // 删除历史记录
        function deleteHistoryItem(index) {
            layui.layer.confirm('确定要删除这条记录吗？', {
                btn: ['确定', '取消']
            }, function() {
                let history = JSON.parse(localStorage.getItem('testHistory') || '[]');
                history.splice(index, 1);
                localStorage.setItem('testHistory', JSON.stringify(history));
                showTestHistory(); // 刷新历史记录显示
                layui.layer.msg('删除成功');
            });
        }

        // 修改原有的 showTestResult 函数
        function showTestResult(result) {
            let content = `
                <div style="padding: 20px;">
                    <h3>测试结果统计</h3>
                    <table class="layui-table">
                        <tbody>
                            <tr>
                                <td>测试时长</td>
                                <td>${result.duration.toFixed(2)} 秒</td>
                            </tr>
                            <tr>
                                <td>总请求数</td>
                                <td>${result.totalRequests.toLocaleString()}</td>
                            </tr>
                            <tr>
                                <td>平均 QPS</td>
                                <td>${result.avgQps.toFixed(2)}</td>
                            </tr>
                            <tr>
                                <td>平均响应时间</td>
                                <td>${result.avgResponseTime.toFixed(2)} ms</td>
                            </tr>
                            <tr>
                                <td>成功率</td>
                                <td>${result.successRate.toFixed(2)}%</td>
                            </tr>
                            <tr>
                                <td>总吞吐量</td>
                                <td>${result.totalTraffic.toFixed(2)} Mbps</td>
                            </tr>
                            <tr>
                                <td>发送流量</td>
                                <td>${result.send.toFixed(2)} Mbps</td>
                            </tr>
                            <tr>
                                <td>接收流量</td>
                                <td>${result.receive.toFixed(2)} Mbps</td>
                            </tr>
                            <tr>
                                <td>状态码分布</td>
                                <td>${Object.entries(result.statusCodes)
                                    .map(([code, count]) => `${code}: ${count}`)
                                    .join('<br>')}</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            `;

            layui.layer.open({
                type: 1,
                title: '测试完成',
                area: ['500px', '600px'],
                content: content,
                btn: ['保存', '关闭'],
                yes: function(index) {
                    saveTestResult(result);
                    layui.layer.msg('结果已保存');
                    layui.layer.close(index);
                },
                btn2: function(index) {
                    layui.layer.close(index);
                }
            });
        }

        // 修改停止测试函数
        function stopTest() {
            if (!isTestRunning) return;
            stopPolling();
            fetch('/api/test/stop', {
                method: 'POST'
            })
            .then(response => response.json())
            .then(data => {
                layui.layer.msg('测试已停止');
                isTestRunning = false;
                updateButtonStates();
                stopPolling();
                
                // 显示测试结果
                if (data.result) {
                    showTestResult(data.result);
                }
            })
            .catch(error => {
                layui.layer.msg('停止失败：' + error.message);
            });
        }

        function startPolling() {
            // 初始化图表
            initCharts();
            // 开始轮询
            pollInterval = setInterval(fetchTestStatus, 1000);
        }

        function stopPolling() {
            if (pollInterval) {
                clearInterval(pollInterval);
                pollInterval = null;
            }
        }

        function fetchTestStatus() {
            fetch('/api/test/status')
                .then(response => response.json())
                .then(data => {
                    if (!data.running) {
                        isTestRunning = false;
                        updateButtonStates();
                        stopPolling();
                        // 如果有最终结果，显示结果弹窗
                        if (data.result) {
                            showTestResult(data.result);
                        }
                        return;
                    }
                    updateCharts(data);
                })
                .catch(error => {
                    console.error('获取状态失败：', error);
                    layui.layer.msg('获取数据失败');
                });
        }

        // 更新图表数据
        function updateCharts(data) {
            if (!data) return;

            document.getElementById('activeConnCount').innerText = data.activeConnCount;
            if (!data.avgQps) {
                return;
            }
            // 更新概览数据
            document.getElementById('currentQps').innerText = data.avgQps.toFixed(2);
            document.getElementById('avgResponseTime').innerText = data.avgResponseTime.toFixed(2) + 'ms';
            document.getElementById('successRate').innerText = data.successRate.toFixed(2) + '%';
            document.getElementById('send').innerText = data.send.toFixed(2) + 'MB/s';
            document.getElementById('receive').innerText = data.receive.toFixed(2) + 'MB/s';
            document.getElementById('runtime').innerText = data.duration.toFixed(2) + 's';
            document.getElementById('activeConnCount').innerText = data.activeConnCount;
            document.getElementById('successCount').innerText = data.successCount;
            // 更新QPS图表
            const qpsChart = echarts.getInstanceByDom(document.getElementById('qpsChart'));
            if (qpsChart && data.qpsData) {
                const option = qpsChart.getOption();
                option.xAxis[0].data.push(data.qpsData[0]);
                option.series[0].data.push(data.qpsData[1]);
                if (option.xAxis[0].data.length > 30) {
                    option.xAxis[0].data.shift();
                    option.series[0].data.shift();
                }
                qpsChart.setOption(option);
            }

            // 更新响应时间图表
            const responseTimeChart = echarts.getInstanceByDom(document.getElementById('responseTimeChart'));
            if (responseTimeChart && data.responseTimeData) {
                const option = responseTimeChart.getOption();
                option.xAxis[0].data.push(data.responseTimeData[0]);
                option.series[0].data.push(data.responseTimeData[1]);
                if (option.xAxis[0].data.length > 30) {
                    option.xAxis[0].data.shift();
                    option.series[0].data.shift();
                }
                responseTimeChart.setOption(option);
            }

            // 更新状态码图表
            const statusCodeChart = echarts.getInstanceByDom(document.getElementById('statusCodeChart'));
            if (statusCodeChart && data.statusCodeData) {
                statusCodeChart.setOption({
                    series: [{
                        data: data.statusCodeData.map(item => ({
                            value: item[1],
                            name: item[0]
                        }))
                    }]
                });
            }

            // 更新流量图表
            const trafficChart = echarts.getInstanceByDom(document.getElementById('trafficChart'));
            if (trafficChart && data.trafficData) {
                const option = trafficChart.getOption();
                option.xAxis[0].data.push(data.trafficData[0]);
                option.series[0].data.push(data.trafficData[1]); // 发送流量
                option.series[1].data.push(data.trafficData[2]); // 接收流量
                if (option.xAxis[0].data.length > 30) {
                    option.xAxis[0].data.shift();
                    option.series[0].data.shift();
                    option.series[1].data.shift();
                }
                trafficChart.setOption(option);
            }
        }

        // 添加远程服务器配置
        function addRemoteServer() {
            const template = `
                <div class="layui-form-item remote-server-item">
                    <div class="layui-inline" style="width: 40%;">
                        <input type="text" class="layui-input" placeholder="服务器地址:端口">
                    </div>
                    <div class="layui-inline" style="width: 40%;">
                        <input type="text" class="layui-input" placeholder="组名列表">
                    </div>
                    <div class="layui-inline" style="width: 10%;">
                        <button type="button" class="layui-btn layui-btn-danger layui-btn-sm" onclick="this.parentElement.parentElement.remove()">
                            <i class="layui-icon">&#xe640;</i>
                        </button>
                    </div>
                </div>
            `;
            
            // 找到远程服务器容器并添加新的服务器配置
            const container = document.getElementById('remoteServerContainer');
            container.insertAdjacentHTML('beforeend', template);
            
            // 重新渲染表单
            layui.form.render();
        }

        function importConfig() {
            document.getElementById('configFileInput').click();
        }

        function handleConfigFile(input) {
            const file = input.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const config = JSON.parse(e.target.result);
                    applyConfig(config);
                    layui.layer.msg('配置导入成功');
                } catch (err) {
                    layui.layer.msg('配置格式错误：' + err.message);
                }
            };
            reader.readAsText(file);
            input.value = ''; // 清除文件选择，允许重复选择同一文件
        }

        function applyConfig(config) {
            // 清除现有配置
            document.getElementById('remoteServerContainer').innerHTML = '';
            document.getElementById('tcpGroupsContainer').innerHTML = '';
            document.getElementById('paramsContainer').innerHTML = '';
            document.getElementById('httpConfContainer').innerHTML = '';

            // 设置基础配置
            document.querySelector('input[name="runtime"]').value = config.RunTime || 30;
            document.querySelector('input[name="debug"]').checked = config.Debug || false;

            // 添加远程服务器配置
            if (config.RemoteServer) {
                for (const [address, groups] of Object.entries(config.RemoteServer)) {
                    addRemoteServer();
                    const item = document.querySelector('#remoteServerContainer .remote-server-item:last-child');
                    item.querySelector('input[placeholder="服务器地址:端口"]').value = address;
                    item.querySelector('input[placeholder="组名列表"]').value = groups.join(',');
                }
            }

            // 添加TCP组配置
            if (config.TcpGroups) {
                config.TcpGroups.forEach(group => {
                    addTcpGroup();
                    const card = document.querySelector('#tcpGroupsContainer .layui-card:last-child');
                    card.querySelector('input[id="Name"]').value = group.Name || '';
                    card.querySelector('input[id="MaxTcpConnPerIP"]').value = group.MaxTcpConnPerIP || 1000;
                    card.querySelector('textarea[id="SrcIP"]').value = (group.SrcIP || []).join(',');
                    card.querySelector('input[id="MaxQps"]').value = group.MaxQPS || 0;
                    card.querySelector('input[id="Dst"]').value = group.Dst || '';
                    card.querySelector('input[id="ReqThread"]').value = group.ReqThread || 100;
                    card.querySelector('input[id="MaxReqest"]').value = group.MaxReqest || 100;
                    card.querySelector('input[id="IsHttps"]').checked = group.IsHttps || false;
                    card.querySelector('input[id="SendHttp"]').value = (group.SendHttp || []).join(',');
                });
            }

            // 添加参数配置
            if (config.Params) {
                config.Params.forEach(param => {
                    addParam();
                    const card = document.querySelector('#paramsContainer .layui-card:last-child');
                    card.querySelector('input[id="Name"]').value = param.Name || '';
                    card.querySelector('select[id="Type"]').value = param.Type || 'RandomInt';
                    card.querySelector('input[id="Spec"]').value = (param.Spec || []).join(',');
                });
            }

            // 添加HTTP配置
            if (config.HTTPconfs) {
                config.HTTPconfs.forEach(conf => {
                    addHttpConf();
                    const card = document.querySelector('#httpConfContainer .layui-card:last-child');
                    card.querySelector('input[id="Name"]').value = conf.Name || '';
                    card.querySelector('select[id="Proto"]').value = conf.Proto || 'HTTP/1.1';
                    card.querySelector('select[id="Method"]').value = conf.Method || 'GET';
                    card.querySelector('input[id="URI"]').value = conf.URI || '';
                    
                    // 设置Headers
                    if (conf.Header) {
                        for (const [key, value] of Object.entries(conf.Header)) {
                            addHeaderField(card.querySelector('button[onclick="addHeaderField(this)"]'));
                            const headerItem = card.querySelector('.headers-container .header-item:last-child');
                            headerItem.querySelector('input[placeholder="Key"]').value = key;
                            headerItem.querySelector('input[placeholder="Value"]').value = value;
                        }
                    }
                    
                    card.querySelector('textarea[id="Body"]').value = conf.Body || '';
                    card.querySelector('input[id="UseParams"]').value = (conf.UseParams || []).join(',');
                });
            }

            layui.form.render(); // 重新渲染所有表单
        }
    </script>
</body>
</html>